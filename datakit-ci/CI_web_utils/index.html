<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>CI_web_utils (datakit-ci.CI_web_utils)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="generator" content="doc-ock-html v1.0.0-1-g1fc9bf0"/></head><body><nav id="top"><a href="../index.html">Up</a> &mdash; <span class="package">package <a href="../index.html">datakit-ci</a></span></nav><header><h1><span class="keyword">Module</span> <span class="module-path">CI_web_utils</span></h1></header><div class="spec module" id="module-Wm"><a href="#module-Wm" class="anchor"></a><div class="def module"><code><span class="keyword">module </span>Wm : Webmachine.S<span class="keyword"> with </span><span class="keyword">type </span>'a <a href="index.html#module-Wm">Wm</a>.io<span class="keyword"> = </span><span class="type-var">'a</span> Lwt.t</code></div><div class="doc"></div></div><div class="spec type" id="type-role"><a href="#type-role" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>role</code><span class="keyword"> = </span><code>[ </code><table class="variant"><tr id="type-role.Reader" class="anchored"><td class="def constructor"><a href="#type-role.Reader" class="anchor"></a><code><span class="keyword">| </span></code><code>`Reader</code></td></tr><tr id="type-role.LoggedIn" class="anchored"><td class="def constructor"><a href="#type-role.LoggedIn" class="anchor"></a><code><span class="keyword">| </span></code><code>`LoggedIn</code></td></tr><tr id="type-role.Builder" class="anchored"><td class="def constructor"><a href="#type-role.Builder" class="anchor"></a><code><span class="keyword">| </span></code><code>`Builder</code></td></tr><tr id="type-role.Admin" class="anchored"><td class="def constructor"><a href="#type-role.Admin" class="anchor"></a><code><span class="keyword">| </span></code><code>`Admin</code></td></tr></table><code> ]</code><code></code></div><div class="doc"><p>Roles are:
</p><ul><li><code class="code">Reader</code> permitted to look at the CI state, build logs, etc</li><li><code class="code">LoggedIn</code> must be logged in (not anonymous)</li><li><code class="code">Builder</code> permitted to control the builds (cancel, rebuild)</li><li><code class="code">Admin</code> is an administrator</li></ul></div></div><div class="spec module" id="module-User"><a href="#module-User" class="anchor"></a><div class="def module"><code><span class="keyword">module </span><a href="User/index.html">User</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="doc"></div></div><div class="spec module" id="module-Auth"><a href="#module-Auth" class="anchor"></a><div class="def module"><code><span class="keyword">module </span><a href="Auth/index.html">Auth</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="doc"></div></div><div class="spec type" id="type-server"><a href="#type-server" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>server</code><code></code><code></code></div><div class="doc"></div></div><div class="spec val" id="val-server"><a href="#val-server" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>server : auth:<a href="Auth/index.html#type-t">Auth.t</a> <span class="keyword">&#8209;&gt;</span> web_config:<a href="../CI_web_templates/index.html#type-t">CI_web_templates.t</a> <span class="keyword">&#8209;&gt;</span> session_backend:[&lt; `Memory | `Redis of Redis_lwt.Client.connection Lwt_pool.t ] <span class="keyword">&#8209;&gt;</span> public_address:Uri.t <span class="keyword">&#8209;&gt;</span> <a href="index.html#type-server">server</a></code></div><div class="doc"></div></div><div class="spec val" id="val-web_config"><a href="#val-web_config" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>web_config : <a href="index.html#type-server">server</a> <span class="keyword">&#8209;&gt;</span> <a href="../CI_web_templates/index.html#type-t">CI_web_templates.t</a></code></div><div class="doc"></div></div><div class="spec module" id="module-Session_data"><a href="#module-Session_data" class="anchor"></a><div class="def module"><code><span class="keyword">module </span><a href="Session_data/index.html">Session_data</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="doc"></div></div><div class="spec class-type" id="class-type-resource"><a href="#class-type-resource" class="anchor"></a><div class="def class-type"><code><span class="keyword">class type </span><a href="class-resource/index.html">resource</a> = <span class="keyword">object</span> ... <span class="keyword">end</span></code></div><div class="doc"></div></div><div class="spec class" id="class-static"><a href="#class-static" class="anchor"></a><div class="def class"><code><span class="keyword">class </span><a href="class-static/index.html">static</a> : valid:Str.regexp <span class="keyword">&#8209;&gt;</span> mime_type:(Uri.t <span class="keyword">&#8209;&gt;</span> string option) <span class="keyword">&#8209;&gt;</span> string <span class="keyword">&#8209;&gt;</span> <a href="index.html#class-type-resource">resource</a></code></div><div class="doc"><p><code class="code">new static ~valid ~mime_type dir</code> serves up files from the directory <code class="code">dir</code>, taking the leafname from the context.
Names must match the RE <code class="code">valid</code> and the MIME type returned will be <code class="code">mime_type uri</code>.</p></div></div><div class="spec class" id="class-static_crunch"><a href="#class-static_crunch" class="anchor"></a><div class="def class"><code><span class="keyword">class </span><a href="class-static_crunch/index.html">static_crunch</a> : mime_type:(Uri.t <span class="keyword">&#8209;&gt;</span> string option) <span class="keyword">&#8209;&gt;</span> (string <span class="keyword">&#8209;&gt;</span> string option) <span class="keyword">&#8209;&gt;</span> <a href="index.html#class-type-resource">resource</a></code></div><div class="doc"><p><code class="code">new static_crunch ~mime_type read</code> serves up files using the function <code class="code">read</code>, taking the path from the context.
The MIME type returned will be <code class="code">mime_type uri</code>.</p></div></div><div class="spec class" id="class-resource_with_session"><a href="#class-resource_with_session" class="anchor"></a><div class="def class"><code><span class="keyword">class </span><span class="keyword">virtual </span><a href="class-resource_with_session/index.html">resource_with_session</a> : <a href="index.html#type-server">server</a> <span class="keyword">&#8209;&gt;</span> <span class="keyword">object</span> ... <span class="keyword">end</span></code></div><div class="doc"><p><code class="code">resource_with_session</code> ensures there is a session for each request.</p></div></div><div class="spec class" id="class-login_page"><a href="#class-login_page" class="anchor"></a><div class="def class"><code><span class="keyword">class </span><a href="class-login_page/index.html">login_page</a> : <a href="index.html#type-server">server</a> <span class="keyword">&#8209;&gt;</span> <a href="index.html#class-type-resource">resource</a></code></div><div class="doc"><p>Page to serve at <code class="code">/auth/login</code>.</p></div></div><div class="spec class" id="class-auth_intro"><a href="#class-auth_intro" class="anchor"></a><div class="def class"><code><span class="keyword">class </span><a href="class-auth_intro/index.html">auth_intro</a> : <a href="index.html#type-server">server</a> <span class="keyword">&#8209;&gt;</span> <a href="index.html#class-type-resource">resource</a></code></div><div class="doc"><p>Page to serve at <code class="code">/auth/intro/:token</code>.</p></div></div><div class="spec class" id="class-auth_setup"><a href="#class-auth_setup" class="anchor"></a><div class="def class"><code><span class="keyword">class </span><a href="class-auth_setup/index.html">auth_setup</a> : <a href="index.html#type-server">server</a> <span class="keyword">&#8209;&gt;</span> <a href="index.html#class-type-resource">resource</a></code></div><div class="doc"><p>Page to serve at <code class="code">/auth/setup</code>.</p></div></div><div class="spec class" id="class-github_callback"><a href="#class-github_callback" class="anchor"></a><div class="def class"><code><span class="keyword">class </span><a href="class-github_callback/index.html">github_callback</a> : <a href="index.html#type-server">server</a> <span class="keyword">&#8209;&gt;</span> <a href="index.html#class-type-resource">resource</a></code></div><div class="doc"><p>Page to serve at <code class="code">/auth/github-callback</code></p></div></div><div class="spec class" id="class-protected_page"><a href="#class-protected_page" class="anchor"></a><div class="def class"><code><span class="keyword">class </span><span class="keyword">virtual </span><a href="class-protected_page/index.html">protected_page</a> : <a href="index.html#type-server">server</a> <span class="keyword">&#8209;&gt;</span> <span class="keyword">object</span> ... <span class="keyword">end</span></code></div><div class="doc"><p>The <code class="code">is_authorized</code> method checks that the session has an associated user and asks the
user to log in if not.
<code class="code">authenticated_user</code> returns the name of the user once <code class="code">is_authorized</code> has completed.</p></div></div><div class="spec class" id="class-post_page"><a href="#class-post_page" class="anchor"></a><div class="def class"><code><span class="keyword">class </span><span class="keyword">virtual </span><a href="class-post_page/index.html">post_page</a> : <a href="index.html#type-server">server</a> <span class="keyword">&#8209;&gt;</span> <span class="keyword">object</span> ... <span class="keyword">end</span></code></div><div class="doc"><p><code class="code">post_page</code> accepts form POST submissions.
It overrides <code class="code">forbidden</code> to check that the CSRF token is present and correct.</p></div></div><div class="spec class" id="class-logout_page"><a href="#class-logout_page" class="anchor"></a><div class="def class"><code><span class="keyword">class </span><a href="class-logout_page/index.html">logout_page</a> : <a href="index.html#type-server">server</a> <span class="keyword">&#8209;&gt;</span> <a href="index.html#class-type-resource">resource</a></code></div><div class="doc"><p>Posting to this page logs the user out and redirects to <code class="code">/</code>.</p></div></div><div class="spec val" id="val-serve"><a href="#val-serve" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>serve : mode:Conduit_lwt_unix.server <span class="keyword">&#8209;&gt;</span> routes:(string<span class="keyword"> * </span>(unit <span class="keyword">&#8209;&gt;</span> Cohttp_lwt_body.t <a href="index.html#module-Wm">Wm</a>.resource)) list <span class="keyword">&#8209;&gt;</span> unit Lwt.t</code></div><div class="doc"><p><code class="code">serve ~mode ~routes</code> runs a web-server listening on <code class="code">mode</code> that dispatches incoming requests using <code class="code">routes</code>.</p></div></div><div class="spec class" id="class-html_page"><a href="#class-html_page" class="anchor"></a><div class="def class"><code><span class="keyword">class </span><span class="keyword">virtual </span><a href="class-html_page/index.html">html_page</a> : <a href="index.html#type-server">server</a> <span class="keyword">&#8209;&gt;</span> <span class="keyword">object</span> ... <span class="keyword">end</span></code></div><div class="doc"></div></div><div class="spec class" id="class-form_page"><a href="#class-form_page" class="anchor"></a><div class="def class"><code><span class="keyword">class </span><span class="keyword">virtual </span>'a <a href="class-form_page/index.html">form_page</a> : <a href="index.html#type-server">server</a> <span class="keyword">&#8209;&gt;</span> <span class="keyword">object</span> ... <span class="keyword">end</span></code></div><div class="doc"></div></div><div class="spec class" id="class-github_auth_settings"><a href="#class-github_auth_settings" class="anchor"></a><div class="def class"><code><span class="keyword">class </span><a href="class-github_auth_settings/index.html">github_auth_settings</a> : <a href="index.html#type-server">server</a> <span class="keyword">&#8209;&gt;</span> <a href="index.html#class-type-resource">resource</a></code></div><div class="doc"><p>The GitHub authentication settings page.</p></div></div></body></html>