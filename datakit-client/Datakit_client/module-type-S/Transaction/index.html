<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Transaction (datakit-client.Datakit_client.S.Transaction)</title><link rel="stylesheet" href="../../../../odoc.css"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="generator" content="doc-ock-html v1.0.0-1-g1fc9bf0"/></head><body><nav id="top"><a href="../index.html">Up</a> &mdash; <span class="package">package <a href="../../../index.html">datakit-client</a></span></nav><header><h1><span class="keyword">Module</span> <span class="module-path">Datakit_client.S.Transaction</span></h1></header><p>All changes to a branch are made in transactions. When a
transaction is committed, it is merged with the current
contents of the branch.</p><h3>Reading</h3><div class="spec include"><div class="doc"></div><details open="open"><summary><span class="def"><code><span class="keyword">include </span><a href="../../index.html#module-type-READABLE_TREE">READABLE_TREE</a><span class="keyword"> with </span><span class="keyword">type </span>a <a href="../../module-type-READABLE_TREE/index.html#type-result">result</a> := a <a href="../index.html#type-result">result</a></code></span></summary><div class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>t</code><code></code><code></code></div><div class="doc"><p>The type for trees.</p></div></div><div class="spec type" id="type-result"><a href="#type-result" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>+'a result</code><code></code><code></code></div><div class="doc"><p>The type for results.</p></div></div><div class="spec val" id="val-read"><a href="#val-read" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>read : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> <a href="../../Path/index.html#type-t">Path.t</a> <span class="keyword">&#8209;&gt;</span> <a href="../../index.html#type-value">value</a> <a href="index.html#type-result">result</a></code></div><div class="doc"><p><code class="code">read t path</code> is the contents of the object at the <code class="code">path</code>.</p></div></div><div class="spec val" id="val-stat"><a href="#val-stat" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>stat : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> <a href="../../Path/index.html#type-t">Path.t</a> <span class="keyword">&#8209;&gt;</span> <a href="../../index.html#type-stat">stat</a> option <a href="index.html#type-result">result</a></code></div><div class="doc"><p><code class="code">stat t path</code> is the metadata of the object at <code class="code">path</code>.</p></div></div><div class="spec val" id="val-exists"><a href="#val-exists" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>exists : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> <a href="../../Path/index.html#type-t">Path.t</a> <span class="keyword">&#8209;&gt;</span> bool <a href="index.html#type-result">result</a></code></div><div class="doc"><p><code class="code">exists t path</code> is <code class="code">true</code> if <code class="code">stat t path</code> isn't <code class="code">None</code>.</p></div></div><div class="spec val" id="val-exists_file"><a href="#val-exists_file" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>exists_file : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> <a href="../../Path/index.html#type-t">Path.t</a> <span class="keyword">&#8209;&gt;</span> bool <a href="index.html#type-result">result</a></code></div><div class="doc"><p><code class="code">exists_file t path</code> is similar to <a href="index.html#val-exists">exists</a> but for files
only.</p></div></div><div class="spec val" id="val-exists_dir"><a href="#val-exists_dir" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>exists_dir : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> <a href="../../Path/index.html#type-t">Path.t</a> <span class="keyword">&#8209;&gt;</span> bool <a href="index.html#type-result">result</a></code></div><div class="doc"><p><code class="code">exists_dir t path</code> is similar to <a href="index.html#val-exists">exists</a> but for directories
only.</p></div></div><div class="spec val" id="val-read_file"><a href="#val-read_file" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>read_file : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> <a href="../../Path/index.html#type-t">Path.t</a> <span class="keyword">&#8209;&gt;</span> Cstruct.t <a href="index.html#type-result">result</a></code></div><div class="doc"><p><code class="code">read_file t path</code> resolves <code class="code">path</code> to a file, or returns an
error if it isn't a file.</p></div></div><div class="spec val" id="val-read_dir"><a href="#val-read_dir" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>read_dir : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> <a href="../../Path/index.html#type-t">Path.t</a> <span class="keyword">&#8209;&gt;</span> string list <a href="index.html#type-result">result</a></code></div><div class="doc"><p><code class="code">read_dir t path</code> resolves <code class="code">path</code> to a directory, or returns an
error if it isn't one.</p></div></div><div class="spec val" id="val-read_link"><a href="#val-read_link" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>read_link : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> <a href="../../Path/index.html#type-t">Path.t</a> <span class="keyword">&#8209;&gt;</span> string <a href="index.html#type-result">result</a></code></div><div class="doc"><p><code class="code">read_link t path</code> resolves <code class="code">path</code> to a symlink, or returns an
error if it isn't one.</p></div></div></details></div><h3>Writing</h3><div class="spec val" id="val-create_dir"><a href="#val-create_dir" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>create_dir : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> <a href="../../Path/index.html#type-t">Path.t</a> <span class="keyword">&#8209;&gt;</span> unit <a href="../index.html#type-result">result</a></code></div><div class="doc"><p><code class="code">create_dir t path</code> creates the directory <code class="code">path</code>.</p></div></div><div class="spec val" id="val-create_file"><a href="#val-create_file" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>create_file : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> <a href="../../Path/index.html#type-t">Path.t</a> <span class="keyword">&#8209;&gt;</span> ?&#8288;executable:bool <span class="keyword">&#8209;&gt;</span> Cstruct.t <span class="keyword">&#8209;&gt;</span> unit <a href="../index.html#type-result">result</a></code></div><div class="doc"><p><code class="code">create_file t path ?executable content</code> creates the file
<code class="code">path</code>.</p></div></div><div class="spec val" id="val-create_symlink"><a href="#val-create_symlink" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>create_symlink : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> <a href="../../Path/index.html#type-t">Path.t</a> <span class="keyword">&#8209;&gt;</span> string <span class="keyword">&#8209;&gt;</span> unit <a href="../index.html#type-result">result</a></code></div><div class="doc"><p><code class="code">create_symlink t path target</code> creates the symlink <code class="code">path</code>.</p></div></div><div class="spec val" id="val-replace_file"><a href="#val-replace_file" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>replace_file : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> <a href="../../Path/index.html#type-t">Path.t</a> <span class="keyword">&#8209;&gt;</span> Cstruct.t <span class="keyword">&#8209;&gt;</span> unit <a href="../index.html#type-result">result</a></code></div><div class="doc"><p><code class="code">replace_file t path new_content</code> changes the content of
the existing file <code class="code">path</code>.</p></div></div><div class="spec val" id="val-create_or_replace_file"><a href="#val-create_or_replace_file" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>create_or_replace_file : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> <a href="../../Path/index.html#type-t">Path.t</a> <span class="keyword">&#8209;&gt;</span> Cstruct.t <span class="keyword">&#8209;&gt;</span> unit <a href="../index.html#type-result">result</a></code></div><div class="doc"><p><code class="code">create_or_replace_file t path content</code> uses either <code class="code">create_file</code>
or <code class="code">replace_file</code> as appropriate to set the contents.</p></div></div><div class="spec val" id="val-set_executable"><a href="#val-set_executable" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>set_executable : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> <a href="../../Path/index.html#type-t">Path.t</a> <span class="keyword">&#8209;&gt;</span> bool <span class="keyword">&#8209;&gt;</span> unit <a href="../index.html#type-result">result</a></code></div><div class="doc"><p><code class="code">set_executable t path flag</code> marks the file at <code class="code">path</code> as
executable or not.</p></div></div><div class="spec val" id="val-remove"><a href="#val-remove" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>remove : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> <a href="../../Path/index.html#type-t">Path.t</a> <span class="keyword">&#8209;&gt;</span> unit <a href="../index.html#type-result">result</a></code></div><div class="doc"><p><code class="code">remove t path</code> removes <code class="code">path</code>. If <code class="code">path</code> is a directory then
the entire subtree is removed.</p></div></div><div class="spec val" id="val-truncate"><a href="#val-truncate" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>truncate : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> <a href="../../Path/index.html#type-t">Path.t</a> <span class="keyword">&#8209;&gt;</span> int64 <span class="keyword">&#8209;&gt;</span> unit <a href="../index.html#type-result">result</a></code></div><div class="doc"><p><code class="code">truncate t path length</code> sets the length of the file at <code class="code">path</code>
to <code class="code">length</code>. If <code class="code">length</code> is longer than the current length,
the file is padded with zero bytes.</p></div></div><div class="spec val" id="val-make_dirs"><a href="#val-make_dirs" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>make_dirs : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> <a href="../../Path/index.html#type-t">Path.t</a> <span class="keyword">&#8209;&gt;</span> unit <a href="../index.html#type-result">result</a></code></div><div class="doc"><p><code class="code">make_dirs t path</code> ensures that <code class="code">path</code> exists and is a
directory, creating it and any missing parents as
necessary.</p></div></div><h3>Finishing</h3><div class="spec val" id="val-commit"><a href="#val-commit" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>commit : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> message:string <span class="keyword">&#8209;&gt;</span> unit <a href="../index.html#type-result">result</a></code></div><div class="doc"><p><code class="code">commit t ~message</code> creates a new commit with the given log
message and the current contents of the transaction and then
merges it into the branch from which the transaction was
created. The transaction cannot be used after calling
this.</p></div></div><div class="spec val" id="val-abort"><a href="#val-abort" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>abort : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> unit <a href="../index.html#type-result">result</a></code></div><div class="doc"><p><code class="code">abort t</code> aborts the transaction without committing it. The
transaction cannot be used after calling this.</p></div></div><h3>Merging and history</h3><div class="spec type" id="type-merge_inputs"><a href="#type-merge_inputs" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>merge_inputs</code><code></code><code><span class="keyword"> = </span></code><code>{</code><table class="record"><tr id="type-merge_inputs.ours" class="anchored"><td class="def field"><a href="#type-merge_inputs.ours" class="anchor"></a><code>ours : <a href="../Tree/index.html#type-t">Tree.t</a>;</code></td></tr><tr id="type-merge_inputs.theirs" class="anchored"><td class="def field"><a href="#type-merge_inputs.theirs" class="anchor"></a><code>theirs : <a href="../Tree/index.html#type-t">Tree.t</a>;</code></td></tr><tr id="type-merge_inputs.base" class="anchored"><td class="def field"><a href="#type-merge_inputs.base" class="anchor"></a><code>base : <a href="../Tree/index.html#type-t">Tree.t</a>;</code></td></tr></table><code>}</code><code></code></div><div class="doc"><p>When performing a merge, these three directories can be used
to calculate the final result. <code class="code">ours</code> is the previous
contents of the transaction, <code class="code">theirs</code> is the commit being
merged and <code class="code">base</code> is a least common ancestor. If there is no
common ancestor then <code class="code">base</code> is an empty tree.</p></div></div><div class="spec val" id="val-merge"><a href="#val-merge" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>merge : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> <a href="../Commit/index.html#type-t">Commit.t</a> <span class="keyword">&#8209;&gt;</span> (<a href="index.html#type-merge_inputs">merge_inputs</a><span class="keyword"> * </span><a href="../../Path/index.html#type-t">Path.t</a> list) <a href="../index.html#type-result">result</a></code></div><div class="doc"><p><code class="code">merge t commit</code> merges <code class="code">commit</code> into the transaction. It
performs any trivial merges it can and returns <code class="code">(merge_inputs,
        conflicts)</code> to allow you to resolve the remaining ones. You
must write to each path in <code class="code">conflicts</code> at least once before
you can commit the transaction. You may perform multiple
merges in one transaction, but the <code class="code">merge_inputs</code> returned is
only valid until the start of the next merge.</p></div></div><div class="spec val" id="val-parents"><a href="#val-parents" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>parents : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> <a href="../Commit/index.html#type-t">Commit.t</a> list <a href="../index.html#type-result">result</a></code></div><div class="doc"><p><code class="code">parents t</code> is the parents of the transaction (that is, the parents of
the commit that would be generated if you committed now.</p></div></div><div class="spec val" id="val-set_parents"><a href="#val-set_parents" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>set_parents : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> <a href="../Commit/index.html#type-t">Commit.t</a> list <span class="keyword">&#8209;&gt;</span> unit <a href="../index.html#type-result">result</a></code></div><div class="doc"><p><code class="code">set_parents t new_parents</code> replaces the current list of
parents. Note that this does not perform a merge - it only
affects the metadata. Note also that <code class="code">merge</code> automatically
updates the parents, so it is not necessary to call it
manually in that case.</p></div></div><div class="spec val" id="val-conflicts"><a href="#val-conflicts" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>conflicts : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> <a href="../../Path/index.html#type-t">Path.t</a> list <a href="../index.html#type-result">result</a></code></div><div class="doc"><p><code class="code">conflicts t</code> returns the current list of paths that had merge
conflicts and have not been written to since. It is not
possible to commit while this is non-empty.</p></div></div><div class="spec val" id="val-diff"><a href="#val-diff" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>diff : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> <a href="../Commit/index.html#type-t">Commit.t</a> <span class="keyword">&#8209;&gt;</span> <a href="../../Path/index.html#type-t">Path.t</a> <a href="../../index.html#type-diff">diff</a> list <a href="../index.html#type-result">result</a></code></div><div class="doc"><p><code class="code">diff t c</code> returns the paths differences between <code class="code">c</code> and <code class="code">t</code>'s
head.</p></div></div><div class="spec val" id="val-closed"><a href="#val-closed" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>closed : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> bool</code></div><div class="doc"><p><code class="code">closed t</code> is true if <code class="code">t</code> is closed and thus it is not valid
to read/write on it anymore.</p></div></div></body></html>